@page
@model CasinoDeYann.Pages.GoldMine

@{
    ViewData["Title"] = "Mine d'or";
    <link rel="stylesheet" href="~/css/GoldMine.css" asp-append-version="true"/>
}

<div class="goldmine-container">
    <img
        src="~/assets/GoldMine/machine/machine2.png"
        alt="Gold Mine"
        class="goldmine-gif"
    />
    <img
        src="~/assets/GoldMine/machine/machine_blocked.png"
        alt="Machine Blocked"
        id="machine-blocked"
        class="blocked"
    />
    <div class="nugget-wrapper" id="nugget-wrapper">
        <img
            src="~/assets/GoldMine/nugget/nugget.png"
            alt="Gold Nugget"
            class="nugget"
            id="nugget"
        />
    </div>
    <div class="info" id="money-text">Monnaie</div>
    <div class="info" id="money-amount">@(Model.CurrentUser?.Money ?? 0)</div>
    <button id="spin" type="button"></button>

</div>

@section Scripts {
    <script>
        const nugget = document.getElementById("nugget");
        const button = document.getElementById("spin");
        const moneyEl = document.getElementById("money-amount");
        const moneyDisplay = document.getElementById("user-money");
        
        const blockedOverlay = document.getElementById("machine-blocked");

        let isMining = false;

        function refreshBlockedState() {
            const moneyDisplay = document.getElementById("user-money");
            const amount = parseInt(moneyDisplay.textContent);
            if (amount >= 100) {
                blockedOverlay.style.display = "block";
                button.disabled = true;
            } else {
                blockedOverlay.style.display = "none";
                button.disabled = false;
            }
}
        refreshBlockedState();
        
        let clicks = 0;

        button.addEventListener("click", async () => {
            if (isMining) return;
            isMining = true;

            clicks += 1;    
 
            const amount = parseInt(moneyDisplay.textContent, 10);
            refreshBlockedState();

            if (amount < 100) {
                nugget.classList.add("shake");

                if (clicks >= 5) {
                    moneyDisplay.textContent = String(amount + 5);
                    moneyEl.textContent      = String(amount + 5);
                    clicks = 0;
                    try {
                        await fetch("/api/GoldMine/mine", { method: "POST" });
                    } catch (err) {
                        console.error("Mining failed:", err);
                    }
                }

                isMining = false;
            }

            // remove shake after animation
            setTimeout(() => {
                nugget.classList.remove("shake");
            }, 300);
        });
    </script>
}
