@page
@model CasinoDeYann.Pages.SlotMachine

@{
ViewData["Title"] = "Machine à sous";
<link rel="stylesheet" href="~/css/SlotMachine.css" asp-append-version="true"/>
}

<div class="machine-container">
    <!-- slot.gif is now the "machine" graphic itself -->
    <img
        src="~/assets/SlotMachine/background/slot2.png"
        alt="Slotachine"
        class="machine-gif"
    />
    <div class="slot-machine">
        <div id="row1" class="row">
            <img id="11" class="slot-symbol" src="assets/SlotMachine/bell/bell.png" alt=""/>
            <img id="12" class="slot-symbol" src="assets/SlotMachine/bell/bell.png" alt=""/>
            <img id="13" class="slot-symbol" src="assets/SlotMachine/bell/bell.png" alt=""/>
            <img id="14" class="slot-symbol" src="assets/SlotMachine/bell/bell.png" alt=""/>
            <img id="15" class="slot-symbol" src="assets/SlotMachine/bell/bell.png" alt=""/>
        </div>
        <div id="row2" class="row">
            <img id="21" class="slot-symbol" src="~/assets/SlotMachine/cherry/cherry.png" alt=""/>
            <img id="22" class="slot-symbol" src="~/assets/SlotMachine/cherry/cherry.png" alt=""/>
            <img id="23" class="slot-symbol" src="~/assets/SlotMachine/cherry/cherry.png" alt=""/>
            <img id="24" class="slot-symbol" src="~/assets/SlotMachine/cherry/cherry.png" alt=""/>
            <img id="25" class="slot-symbol" src="~/assets/SlotMachine/cherry/cherry.png" alt=""/>
        </div>
        <div id="row3" class="row">
            <img id="31" class="slot-symbol" src="~/assets/SlotMachine/diamond/diamond.png" alt=""/>
            <img id="32" class="slot-symbol" src="~/assets/SlotMachine/diamond/diamond.png" alt=""/>
            <img id="33" class="slot-symbol" src="~/assets/SlotMachine/diamond/diamond.png" alt=""/>
            <img id="34" class="slot-symbol" src="~/assets/SlotMachine/diamond/diamond.png" alt=""/>
            <img id="35" class="slot-symbol" src="~/assets/SlotMachine/diamond/diamond.png" alt=""/>
        </div>
        <div id="row4" class="row">
            <img id="41" class="slot-symbol" src="~/assets/SlotMachine/diamond/diamond.png" alt=""/>
            <img id="42" class="slot-symbol" src="~/assets/SlotMachine/diamond/diamond.png" alt=""/>
            <img id="43" class="slot-symbol" src="~/assets/SlotMachine/diamond/diamond.png" alt=""/>
            <img id="44" class="slot-symbol" src="~/assets/SlotMachine/diamond/diamond.png" alt=""/>
            <img id="45" class="slot-symbol" src="~/assets/SlotMachine/diamond/diamond.png" alt=""/>
        </div>
        <div id="row5" class="row">
            <img id="51" class="slot-symbol" src="~/assets/SlotMachine/diamond/diamond.png" alt=""/>
            <img id="52" class="slot-symbol" src="~/assets/SlotMachine/diamond/diamond.png" alt=""/>
            <img id="53" class="slot-symbol" src="~/assets/SlotMachine/diamond/diamond.png" alt=""/>
            <img id="54" class="slot-symbol" src="~/assets/SlotMachine/diamond/diamond.png" alt=""/>
            <img id="55" class="slot-symbol" src="~/assets/SlotMachine/diamond/diamond.png" alt=""/>
        </div>
    </div>

    <!-- BET AMOUNT DISPLAY -->
    <div id="bet-amount">Mise : 1</div>

    <!-- MINUS AND PLUS BUTTONS -->
    <button id="decrease-bet" type="button"></button>
    <button id="increase-bet" type="button"></button>

    <!-- SPIN BUTTON -->
    <button id="spin" type="button"></button>
</div>

<div id="result-message"></div>

@section Scripts {
<script>
    let running = false;
    
    let bet = 1;
    const betDisplay = document.getElementById("bet-amount");
    const decreaseBtn = document.getElementById("decrease-bet");
    const increaseBtn = document.getElementById("increase-bet");

    let bets = [1,2,5,10,20,25,50,75,100,200,250,500,750,1000]
    let betIndex = 1;
    
    decreaseBtn.addEventListener("click", () => {
        if (betIndex > 0) {
            betIndex--;
            bet = bets[betIndex];
            betDisplay.textContent = `Mise : ${bet}`;
        }
    });

    increaseBtn.addEventListener("click", () => {
        if (betIndex < bets.length - 1) {
            betIndex++;
            bet = bets[betIndex];
            betDisplay.textContent = `Mise : ${bet}`;
        }
    });
    // — BET CONTROLS END — 

    const symbols = [
        "/assets/SlotMachine/bell/bell.png",
        "/assets/SlotMachine/cherry/cherry.png",
        "/assets/SlotMachine/diamond/diamond.png",
        "/assets/SlotMachine/heart/heart.png",
        "/assets/SlotMachine/horseshoe/horseshoe.png",
        "/assets/SlotMachine/seven/seven.png",
        "/assets/SlotMachine/watermelon/watermelon.png",
        "/assets/SlotMachine/wildcard/wildcard.png",
        "/assets/SlotMachine/yann/yann.png",
    ];
    
    const symbolsHighlighted = [
        "/assets/SlotMachine/bell/bell_shine.gif",
        "/assets/SlotMachine/cherry/cherry_shine.gif",
        "/assets/SlotMachine/diamond/diamond_shine.gif",
        "/assets/SlotMachine/heart/heart_shine.gif",
        "/assets/SlotMachine/horseshoe/horseshoe_shine.gif",
        "/assets/SlotMachine/seven/seven_shine.gif",
        "/assets/SlotMachine/watermelon/watermelon_shine.gif",
        "/assets/SlotMachine/wildcard/wildcard_shine.gif",
        "/assets/SlotMachine/yann/yann_shine.gif",
    ]

    const gridUI = [
        [
            document.getElementById("11"),
            document.getElementById("12"),
            document.getElementById("13"),
            document.getElementById("14"),
            document.getElementById("15"),
        ],
        [
            document.getElementById("21"),
            document.getElementById("22"),
            document.getElementById("23"),
            document.getElementById("24"),
            document.getElementById("25"),
        ],
        [
            document.getElementById("31"),
            document.getElementById("32"),
            document.getElementById("33"),
            document.getElementById("34"),
            document.getElementById("35"),
        ],
        [
            document.getElementById("41"),
            document.getElementById("42"),
            document.getElementById("43"),
            document.getElementById("44"),
            document.getElementById("45"),
        ],
        [
            document.getElementById("51"),
            document.getElementById("52"),
            document.getElementById("53"),
            document.getElementById("54"),
            document.getElementById("55"),
        ]
    ];
    
    let patterns;
    let grid;

    function getRandomInt(min, max) {
        min = Math.ceil(min);
        max = Math.floor(max);
        return Math.floor(Math.random() * (max - min)) + min;
    }

    function initializeGrid() {
        for (let row = 1; row <= 5; row++) {
            for (let col = 1; col <= 5; col++) {
                const id = `${row}${col}`;
                const img = document.getElementById(id);
                if (img) img.src = symbols[getRandomInt(0, symbols.length)];
            }
        }
    }

    document.addEventListener("DOMContentLoaded", () => {
        initializeGrid();
    });

    function setCol(col, grid) {
        for (let i = 0; i < grid.length; i++) {
            setTimeout(() => {
                animate(col);
                gridUI[0][col].src = symbols[grid[grid.length - 1 - i][col]]}, i * 500
            );
        }
    }

    function animate(index) {
        gridUI[4][index].src = gridUI[3][index].src;
        gridUI[3][index].src = gridUI[2][index].src;
        gridUI[2][index].src = gridUI[1][index].src;
        gridUI[1][index].src = gridUI[0][index].src;
        gridUI[0][index].src = symbols[getRandomInt(0, symbols.length)];
    }
    
    function showPatterns() {
        for (let i = 0; i < patterns.length; i++) {
            for (let j = 0; j < patterns[i].length; j++) {
                if (patterns[i][j]) gridUI[i][j].src = symbolsHighlighted[grid[i][j]];
            }
        }
    }
    
    function resetPatterns() {
        if (!patterns || !grid) return;
        for (let i = 0; i < patterns.length; i++) {
            for (let j = 0; j < patterns[i].length; j++) {
                if (patterns[i][j]) gridUI[i][j].src = symbols[grid[i][j]];
            }
        }
    }

    document.getElementById("spin").addEventListener("click", async () => {
        if (running) return;
        running = true;
        resetPatterns();
        
        // TODO prevent player of playing if not enough money

        const roll0 = setInterval(() => animate(0), getRandomInt(80, 120));
        const roll1 = setInterval(() => animate(1), getRandomInt(80, 120));
        const roll2 = setInterval(() => animate(2), getRandomInt(80, 120));
        const roll3 = setInterval(() => animate(3), getRandomInt(80, 120));
        const roll4 = setInterval(() => animate(4), getRandomInt(80, 120));

        const res = await fetch(`/api/SlotMachine/play/${bet}`, { method: "POST" });
        const data = await res.json();
        grid = data.grid;
        patterns = data.patterns;

        console.log(data);

        setTimeout(() => {
            clearInterval(roll0);
            setCol(0, grid)
        }, 1000 + getRandomInt(500, -500));

        setTimeout(() => {
            clearInterval(roll1);
            setCol(1, grid)
        }, 2000 + getRandomInt(500, -500));

        setTimeout(() => {
            clearInterval(roll2);
            setCol(2, grid)
        }, 3000 + getRandomInt(500, -500));

        setTimeout(() => {
            clearInterval(roll3);
            setCol(3, grid)
        }, 4000 + getRandomInt(500, -500));

        setTimeout(() => {
            clearInterval(roll4);
            setCol(4, grid)
        }, 5000);

        setTimeout(() => {
            showPatterns();
            document.getElementById("result-message").textContent = data.message;

            const moneyDisplay = document.getElementById("user-money");
            console.log(moneyDisplay);
            console.log(data.money);
            if (moneyDisplay && data.money !== undefined) {
                moneyDisplay.textContent = data.money;
            }

            running = false;
        }, 6000);
    });
</script>
}
